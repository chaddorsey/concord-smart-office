<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920, height=1080">
  <title>Who's Here? - Concord Smart Office</title>
  <!-- Adobe Fonts (Museo & Museo Sans) -->
  <link rel="stylesheet" href="https://use.typekit.net/jzs4ixz.css">
  <!-- QR Code library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 1920px;
      height: 1080px;
      overflow: hidden;
    }

    body {
      font-family: 'museo-sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(165deg, #FFCC00 0%, #F3B100 100%);
      color: #1a1a1a;
    }

    .container {
      width: 1920px;
      height: 1080px;
      padding: 48px 64px;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 40px;
    }

    .titles {
      display: flex;
      flex-direction: column;
    }

    .welcome-title {
      font-family: 'museo', Georgia, serif;
      font-weight: 900;
      font-size: 120px;
      color: #1a1a1a;
      line-height: 1;
      margin-bottom: 8px;
    }

    .subtitle {
      font-family: 'museo', Georgia, serif;
      font-weight: 700;
      font-size: 72px;
      color: #1a1a1a;
    }

    .logo {
      height: 168px;
    }

    /* Main content area */
    .content {
      flex: 1;
      display: flex;
      gap: 64px;
    }

    /* Staff list */
    .staff-section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .staff-grid {
      display: grid;
      gap: 16px;
      align-content: start;
    }

    .staff-grid.single-column {
      grid-template-columns: 1fr;
    }

    .staff-grid.two-columns {
      grid-template-columns: 1fr 1fr;
    }

    .staff-card {
      display: flex;
      align-items: center;
      gap: 20px;
      background: rgba(255, 255, 255, 0.25);
      border-radius: 16px;
      padding: 16px 24px;
    }

    .staff-card.large {
      padding: 20px 28px;
    }

    .staff-avatar {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      object-fit: cover;
      object-position: top;
      background: rgba(255, 255, 255, 0.3);
      flex-shrink: 0;
    }

    .staff-card.large .staff-avatar {
      width: 100px;
      height: 100px;
      border-radius: 16px;
    }

    .staff-avatar-placeholder {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'museo-sans', sans-serif;
      font-weight: 900;
      font-size: 28px;
      color: #1a1a1a;
      flex-shrink: 0;
    }

    .staff-card.large .staff-avatar-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 16px;
      font-size: 36px;
    }

    .staff-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .staff-name {
      font-family: 'museo-sans', sans-serif;
      font-weight: 900;
      font-size: 32px;
      color: #1a1a1a;
    }

    .staff-card.large .staff-name {
      font-size: 40px;
    }

    .staff-time {
      font-family: 'museo-sans', sans-serif;
      font-weight: 100;
      font-size: 20px;
      color: rgba(26, 26, 26, 0.7);
    }

    .staff-card.large .staff-time {
      font-size: 24px;
    }

    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0.6;
    }

    .empty-state svg {
      width: 120px;
      height: 120px;
      margin-bottom: 24px;
    }

    .empty-state p {
      font-family: 'museo-sans', sans-serif;
      font-weight: 500;
      font-size: 32px;
    }

    /* CTA section */
    .cta-section {
      width: 480px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding-bottom: 20px;
    }

    .cta-text {
      font-family: 'museo', Georgia, serif;
      font-weight: 500;
      font-size: 36px;
      text-align: center;
      color: #1a1a1a;
      margin-bottom: 32px;
      line-height: 1.3;
    }

    .qr-code {
      width: 384px;
      height: 384px;
      background: white;
      border-radius: 28px;
      padding: 28px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }

    .qr-code canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .wifi-note {
      font-family: 'museo-sans', sans-serif;
      font-weight: 500;
      font-size: 28px;
      text-align: center;
      color: rgba(26, 26, 26, 0.8);
      margin-top: 24px;
      line-height: 1.4;
    }

    .wifi-note em {
      font-style: italic;
    }

    .wifi-note strong {
      font-weight: 700;
    }

    /* Count badge */
    .count-badge {
      position: fixed;
      bottom: 48px;
      left: 64px;
      background: rgba(255, 255, 255, 0.3);
      padding: 16px 32px;
      border-radius: 100px;
      font-family: 'museo-sans', sans-serif;
      font-weight: 700;
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="titles">
        <h1 class="welcome-title">Welcome!</h1>
        <h2 class="subtitle">Who's Here?</h2>
      </div>
      <img
        src="https://concord.org/wp-content/themes/concord2017/images/concord-logo.svg"
        alt="Concord Consortium"
        class="logo"
      >
    </div>

    <!-- Main Content -->
    <div class="content">
      <!-- Staff List -->
      <div class="staff-section">
        <div class="staff-grid single-column" id="staff-grid">
          <!-- Staff cards populated by JS -->
        </div>

        <div class="empty-state" id="empty-state">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <p>Loading...</p>
        </div>
      </div>

      <!-- CTA Section -->
      <div class="cta-section">
        <p class="cta-text">Check In &amp; Download<br>the Concord HQ App!</p>
        <div class="qr-code" id="qr-code"></div>
        <p class="wifi-note">Make sure to join the<br><strong>Concord Consortium</strong> WiFi<br>(Password <em>Cottage25</em>!)</p>
      </div>
    </div>
  </div>

  <div class="count-badge" id="count-badge">0 people here</div>

  <script>
    const API_BASE = window.location.origin;
    const PWA_URL = 'http://concordhq.local/scan';

    // Generate QR Code
    function generateQRCode() {
      const container = document.getElementById('qr-code');
      container.innerHTML = '';

      try {
        new QRCode(container, {
          text: PWA_URL,
          width: 328,
          height: 328,
          colorDark: '#1a1a1a',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.M
        });
        console.log('[Welcome] QR code generated');
      } catch (error) {
        console.error('[Welcome] QR Code error:', error);
      }
    }

    // Format time
    function formatTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    }

    // Get initials
    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    // Get first name
    function getFirstName(name) {
      return name.split(' ')[0];
    }

    // Render staff list
    function renderStaff(people) {
      const grid = document.getElementById('staff-grid');
      const emptyState = document.getElementById('empty-state');
      const countBadge = document.getElementById('count-badge');

      console.log('[Welcome] Rendering', people.length, 'people');

      // Update count
      countBadge.textContent = `${people.length} ${people.length === 1 ? 'person' : 'people'} here`;

      if (people.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'flex';
        emptyState.querySelector('p').textContent = 'No one is here yet';
        return;
      }

      grid.style.display = 'grid';
      emptyState.style.display = 'none';

      // Determine layout: single column for <= 10, two columns for more
      const useTwoColumns = people.length > 10;
      const isLarge = !useTwoColumns;

      grid.className = useTwoColumns ? 'staff-grid two-columns' : 'staff-grid single-column';

      // Sort by check-in time (most recent first)
      const sorted = [...people].sort((a, b) => {
        if (!a.checked_in_at) return 1;
        if (!b.checked_in_at) return -1;
        return new Date(b.checked_in_at).getTime() - new Date(a.checked_in_at).getTime();
      });

      // Limit to 20 people
      const display = sorted.slice(0, 20);

      grid.innerHTML = display.map(person => {
        const firstName = getFirstName(person.user_name || 'Guest');
        const time = formatTime(person.checked_in_at);
        const initials = getInitials(person.user_name || 'G');
        const avatarUrl = person.avatar_url ?
          (person.avatar_url.startsWith('/') ? API_BASE + person.avatar_url : person.avatar_url) :
          null;

        return `
          <div class="staff-card ${isLarge ? 'large' : ''}">
            ${avatarUrl ?
              `<img src="${avatarUrl}" alt="${firstName}" class="staff-avatar">` :
              `<div class="staff-avatar-placeholder">${initials}</div>`
            }
            <div class="staff-info">
              <span class="staff-name">${firstName}</span>
              <span class="staff-time">${time}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // Fetch presence data
    async function fetchPresence() {
      try {
        const res = await fetch(`${API_BASE}/api/presence`, {
          headers: { 'ngrok-skip-browser-warning': 'true' }
        });
        const data = await res.json();
        const users = data.users || data || [];
        const present = users.filter(p => p.status === 'in');
        renderStaff(present);
      } catch (error) {
        console.error('Presence error:', error);
      }
    }

    // Connect to SSE for real-time updates
    let eventSource = null;

    function connectSSE() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource(`${API_BASE}/api/events`);

      eventSource.addEventListener('checkin', () => {
        fetchPresence();
      });

      eventSource.addEventListener('checkout', () => {
        fetchPresence();
      });

      eventSource.addEventListener('error', () => {
        console.error('SSE error, reconnecting in 5s...');
        eventSource.close();
        setTimeout(connectSSE, 5000);
      });
    }

    // Initialize
    console.log('[Welcome] Initializing...');
    generateQRCode();
    fetchPresence();
    connectSSE();
    console.log('[Welcome] Initialization complete');

    // Fallback polling
    setInterval(fetchPresence, 30000);
  </script>
</body>
</html>
