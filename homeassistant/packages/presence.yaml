# Concord Smart Office - Staff Presence System Package

# Staff members - matching PWA mock data for seamless dev/prod parity
input_boolean:
  staff_alice_present:
    name: "Alice Chen - Present"
    icon: mdi:account

  staff_bob_present:
    name: "Bob Smith - Present"
    icon: mdi:account

  staff_carol_present:
    name: "Carol Davis - Present"
    icon: mdi:account

  staff_dave_present:
    name: "Dave Wilson - Present"
    icon: mdi:account

  staff_eve_present:
    name: "Eve Johnson - Present"
    icon: mdi:account

  staff_frank_present:
    name: "Frank Brown - Present"
    icon: mdi:account

# Track arrival times
input_datetime:
  staff_alice_arrival:
    name: "Alice Chen - Arrival Time"
    has_date: true
    has_time: true

  staff_bob_arrival:
    name: "Bob Smith - Arrival Time"
    has_date: true
    has_time: true

  staff_carol_arrival:
    name: "Carol Davis - Arrival Time"
    has_date: true
    has_time: true

  staff_dave_arrival:
    name: "Dave Wilson - Arrival Time"
    has_date: true
    has_time: true

  staff_eve_arrival:
    name: "Eve Johnson - Arrival Time"
    has_date: true
    has_time: true

  staff_frank_arrival:
    name: "Frank Brown - Arrival Time"
    has_date: true
    has_time: true

# Template sensors for presence overview
template:
  - sensor:
      - name: "Staff Currently Present"
        unique_id: staff_currently_present
        state: >
          {{ states.input_boolean
             | selectattr('entity_id', 'match', 'input_boolean.staff_.*_present')
             | selectattr('state', 'eq', 'on')
             | list | count }}
        attributes:
          staff_list: >
            {{ states.input_boolean
               | selectattr('entity_id', 'match', 'input_boolean.staff_.*_present')
               | selectattr('state', 'eq', 'on')
               | map(attribute='name')
               | map('replace', ' - Present', '')
               | list }}

# Automations for presence management
automation:
  - id: presence_scan_in_webhook
    alias: "Presence - Handle Scan In"
    description: "Process scan-in events from QR/NFC"
    trigger:
      - platform: webhook
        webhook_id: staff_scan_in
        local_only: false
    action:
      - service: input_boolean.turn_on
        target:
          entity_id: "input_boolean.staff_{{ trigger.json.staff_id }}_present"
      - service: input_datetime.set_datetime
        target:
          entity_id: "input_datetime.staff_{{ trigger.json.staff_id }}_arrival"
        data:
          datetime: "{{ now().isoformat() }}"
      - event: staff_scanned_in
        event_data:
          staff_id: "{{ trigger.json.staff_id }}"
          location: "{{ trigger.json.location | default('unknown') }}"
          method: "{{ trigger.json.method | default('qr') }}"

  - id: presence_scan_out_webhook
    alias: "Presence - Handle Scan Out"
    description: "Process scan-out events from QR/NFC"
    trigger:
      - platform: webhook
        webhook_id: staff_scan_out
        local_only: false
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: "input_boolean.staff_{{ trigger.json.staff_id }}_present"
      - event: staff_scanned_out
        event_data:
          staff_id: "{{ trigger.json.staff_id }}"
          location: "{{ trigger.json.location | default('unknown') }}"
          method: "{{ trigger.json.method | default('qr') }}"

# Scripts for presence operations
script:
  scan_in_staff:
    alias: "Scan In Staff Member"
    fields:
      staff_id:
        description: "Staff member identifier (e.g., alice, bob)"
        example: "alice"
      location:
        description: "Check-in location"
        example: "office"
      method:
        description: "Scan method (qr, nfc, manual)"
        example: "qr"
    sequence:
      - service: input_boolean.turn_on
        target:
          entity_id: "input_boolean.staff_{{ staff_id }}_present"
      - service: input_datetime.set_datetime
        target:
          entity_id: "input_datetime.staff_{{ staff_id }}_arrival"
        data:
          datetime: "{{ now().isoformat() }}"

  scan_out_staff:
    alias: "Scan Out Staff Member"
    fields:
      staff_id:
        description: "Staff member identifier"
        example: "alice"
    sequence:
      - service: input_boolean.turn_off
        target:
          entity_id: "input_boolean.staff_{{ staff_id }}_present"

  toggle_staff_presence:
    alias: "Toggle Staff Presence"
    fields:
      staff_id:
        description: "Staff member identifier"
        example: "alice"
    sequence:
      - service: input_boolean.toggle
        target:
          entity_id: "input_boolean.staff_{{ staff_id }}_present"
